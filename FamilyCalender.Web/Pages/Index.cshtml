@page
@model FamilyCalender.Web.Pages.IndexModel
@{
	ViewData["Title"] = "Calendar";
	var fixedDayColumnWidth = 8;
	var remainingColumnWidth = Model.ViewModel.Members.Count > 0 ? 100m / Model.ViewModel.Members.Count : 0;
}

<a class="btn btn-primary" asp-page="/CreateCalendar">Skapa kalender</a>
@if (Model.ViewModel.SelectedCalendar.Id == 0)
{
	<p>Ingen kalender hittades</p>
}
else
{

	<h2>@Model.ViewModel.SelectedCalendar.Name</h2>
	<h3 class="d-flex justify-content-between align-items-center">
		<a asp-page="./Index" asp-route-year="@(Model.ViewModel.CurrentMonth == 1 ? Model.ViewModel.CurrentYear - 1 : Model.ViewModel.CurrentYear)"
		   asp-route-month="@(Model.ViewModel.CurrentMonth == 1 ? 12 : Model.ViewModel.CurrentMonth - 1)"
		   asp-route-calendarId="@Model.ViewModel.SelectedCalendar?.Id"
		   class="btn btn-secondary btn-block mb-2">Föregående månad</a>
		<span>@Model.ViewModel.CapitalizedMonthName @Model.ViewModel.CurrentYear</span>
		<a asp-page="./Index" asp-route-year="@(Model.ViewModel.CurrentMonth == 12 ? Model.ViewModel.CurrentYear + 1 : Model.ViewModel.CurrentYear)"
		   asp-route-month="@(Model.ViewModel.CurrentMonth == 12 ? 1 : Model.ViewModel.CurrentMonth + 1)"
		   asp-route-calendarId="@Model.ViewModel.SelectedCalendar?.Id"
		   class="btn btn-secondary btn-block mb-2">Nästa månad</a>
	</h3>

	@if (Model.ViewModel.Calendars != null && Model.ViewModel.Calendars.Count > 1)
	{
		<form method="get">
			<div class="calendar-buttons">
				@foreach (var calendar in Model.ViewModel.Calendars)
				{
					<button type="submit" name="calendarId" value="@calendar.Id"
							class="btn @(calendar.Id == Model.ViewModel.SelectedCalendar?.Id ? "btn-primary" : "btn-outline-primary")">
						@calendar.Name
					</button>
				}
				<input type="hidden" name="year" value="@Model.ViewModel.CurrentYear" />
				<input type="hidden" name="month" value="@Model.ViewModel.CurrentMonth" />
			</div>
		</form>
	}
	<table class="table table-bordered table-striped">
		<thead>
			<tr>
				<th class="col-12 col-md-2 text-center">Dag</th>
				@foreach (var member in Model.ViewModel.Members ?? new List<Core.Models.Entities.Member>())
				{
					<th class="col-12 col-md-2 text-center">@member.Name</th>
				}
			</tr>
		</thead>
		<tbody>
			@foreach (var day in Model.ViewModel.DaysInMonth)
			{
				<tr>
					<td class="col-12 col-md-2">
						@{
							if (day.ShowWeekNumber)
							{
								<b>@($"v. {day.WeekOfYear}")</b>
								<br />
							}
						}

						<span class="@((day.IsCurrentDay ? "fw-bold" : "") + (day.IsPastDay ? " text-muted" : ""))">
							@($"{day.Date.Day} {day.FriendlyDayOfWeek}")
						</span>
						@if (!day.IsPastDay)
						{							
							<a href="javascript:void(0)"
							   class="text-decoration-none ms-2"
							   data-bs-toggle="modal"
							   data-bs-target="#eventModal"
							   data-selected-date="@day.Date.ToString("yyyy-MM-dd")"
							   onclick="setModalValues(this)">
								<i class="bi bi-plus-circle event-icon" title="Lägg till event"></i>
							</a>
						}
					</td>

					@foreach (var member in Model.ViewModel.Members ?? new List<Core.Models.Entities.Member>())
					{
						var eventMemberDates = Model.ViewModel.SelectedCalendar?.Events
						.SelectMany(e => e.EventMemberDates)
						.Where(em => em.MemberId == member.Id && em.Date.Date == day.Date.Date)
						.ToList();
						<td class="col-12 col-md-2">
							<div class="d-flex flex-column">
								<div class="d-flex justify-content-between align-items-start">
									<span class="text-start">
										@if (eventMemberDates?.Any() ?? false)
										{
											foreach (var eventMemberDate in eventMemberDates)
											{
												<a asp-page="./EventDetails"
												   asp-route-eventId="@eventMemberDate.EventId"
												   asp-route-memberId="@member.Id"
												   asp-route-day="@day.Date.ToString("yyyy-MM-dd")"
												   class="text-decoration-none text-dark">
													@eventMemberDate.Event.Title
												</a>
												<br />
											}
										}
									</span>

								</div>
							</div>
						</td>
					}
				</tr>
			}
		</tbody>
	</table>

}

<!-- The Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered modal-lg">
		<div class="modal-content">

			<div class="modal-header">
				<h5 class="modal-title">Lägg till event</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>

			<div class="modal-body">
				<form method="post" asp-page-handler="AddEvent" onsubmit="return validateForm()">

					<div class="mb-3">
						<label class="form-label">@Model.ViewModel.SelectedCalendar?.Name</label>
						<input type="hidden" asp-for="ViewModel.SelectedCalendarId" value="@Model.ViewModel.SelectedCalendar?.Id" />
					</div>

					<div class="mb-3">
						<label for="modalSelectedDate" class="form-label">Datum</label>
						<input type="date" class="form-control" asp-for="ViewModel.SelectedDate" id="modalSelectedDate" readonly/>
						<small id="error-selected-date" class="text-danger d-none"></small>
					</div>

					<div class="accordion" id="eventOptionsAccordion">
						<div class="accordion-item">
							<h2 class="accordion-header" id="headingOne">
								<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
									Skapa intervall
								</button>
							</h2>
							<div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#eventOptionsAccordion">
								<div class="accordion-body">
									<div class="mb-3">
										<label for="startDate" class="form-label">Startdatum</label>
										<input type="date" class="form-control" id="modalStartDate" asp-for="ViewModel.StartDate" />
										<small id="error-start-date" class="text-danger d-none"></small>


									</div>

									<div class="mb-3">
										<label for="endDate" class="form-label">Slutdatum</label>
										<input type="date" class="form-control" id="modalEndDate" asp-for="ViewModel.EndDate" />
										<small id="error-end-date" class="text-danger d-none"></small>

									</div>

									<div class="mb-3">
										<label class="form-label">Välj dagar</label>
										<div class="form-check">
											<input class="form-check-input day-checkbox" type="checkbox" id="monday" name="SelectedDays" value="Måndag" />
											<label class="form-check-label" for="monday">Måndag</label>
										</div>
										<div class="form-check">
											<input class="form-check-input day-checkbox" type="checkbox" id="tuesday" name="SelectedDays" value="Tisdag" />
											<label class="form-check-label" for="tuesday">Tisdag</label>
										</div>
										<div class="form-check">
											<input class="form-check-input day-checkbox" type="checkbox" id="wednesday" name="SelectedDays" value="Onsdag" />
											<label class="form-check-label" for="wednesday">Onsdag</label>
										</div>
										<div class="form-check">
											<input class="form-check-input day-checkbox" type="checkbox" id="thursday" name="SelectedDays" value="Torsdag" />
											<label class="form-check-label" for="thursday">Torsdag</label>
										</div>
										<div class="form-check">
											<input class="form-check-input day-checkbox" type="checkbox" id="friday" name="SelectedDays" value="Fredag" />
											<label class="form-check-label" for="friday">Fredag</label>
										</div>
										<div class="form-check">
											<input class="form-check-input day-checkbox" type="checkbox" id="saturday" name="SelectedDays" value="Lördag" />
											<label class="form-check-label" for="saturday">Lördag</label>
										</div>
										<div class="form-check">
											<input class="form-check-input day-checkbox" type="checkbox" id="sunday" name="SelectedDays" value="Söndag" />
											<label class="form-check-label" for="sunday">Söndag</label>
										</div>
									</div>
									<small id="error-right-weekdays" class="text-danger d-none"></small>
									<small id="error-interval-weekdays" class="text-danger d-none"></small>


								</div>
							</div>
						</div>
					</div>

					<div class="mb-3">
						<label class="form-label">Välj medlemmar</label>
						<div id="memberList">
							@foreach (var member in Model.ViewModel.Members ?? [])
							{
								<div class="form-check">
									<input class="form-check-input member-checkbox" type="checkbox" id="member-@member.Id" value="@member.Id" name="SelectedMemberIds" />
									<label class="form-check-label" for="member-@member.Id">@member.Name</label>
								</div>
							}
						</div>
						<small id="memberError" class="text-danger d-none">Du måste välja minst en medlem</small>
					</div>


					<div class="mb-3">
						<label for="eventTitle" class="form-label">Titel</label>
						<input type="text" class="form-control" asp-for="ViewModel.EventTitle" id="eventTitle" />
						<small id="eventTitleError" class="text-danger d-none">Ange titel</small>
					</div>


					<input type="hidden" asp-for="ViewModel.CurrentYear" value="@Model.ViewModel.CurrentYear" />
					<input type="hidden" asp-for="ViewModel.CurrentMonth" value="@Model.ViewModel.CurrentMonth" />

					<button type="submit" class="btn btn-primary">Skapa Event</button>
				</form>
			</div>

			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Stäng</button>
			</div>

		</div>
	</div>
</div>

