@page
@model FamilyCalender.Web.Pages.EventDetailsModel
@{

}

<div>
	<div>
		<strong>Kalender:</strong> @Model.ViewModel.EventDetails.Calendar.Name
	</div>
	<div>
		<strong>Titel:</strong> @Model.ViewModel.EventDetails.Title
	</div>

	<div>
		@if (Model.ViewModel.IsSingleEvent)
		{

			<strong>Datum:</strong> @Model.ViewModel.FormattedDate
		}
		else
		{
			<strong>Intervall:</strong> @Model.ViewModel.FormattedInterval
			<br />
			<strong>Veckodagar:</strong> @string.Join(", ", Model.ViewModel.SortedDaysInSwedish)
		}
	</div>
	<div>
		<strong>Medlemmar:</strong>
		<ul>
			@foreach (var member in Model.ViewModel.EventDetails.EventMemberDates.Select(x => x.Member).Distinct().ToList())
			{
				<li>@member?.Name</li>
			}
		</ul>
	</div>
	<div>
		<div type="button" class="btn btn-sm btn-primary mb-1" data-bs-toggle="modal" data-bs-target="#editEventModal">
			Redigera event
		</div>
	</div>
	<div>
		<div type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteEventModal">
			Radera event
		</div>
	</div>
</div>

<!-- Modal för att radera eventet-->
<div class="modal fade" id="deleteEventModal" tabindex="-1" aria-labelledby="deleteEventModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<form method="post" asp-page-handler="DeleteEvent">
				<div class="modal-header">
					<h5 class="modal-title" id="deleteEventModalLabel">Radera Event</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Stäng"></button>
				</div>
				<div class="modal-body">

					<!-- Enkelt event på en dag och en person -->
					@if (Model.ViewModel.EventDetails.EventMemberDates.Count == 1 && Model.ViewModel.EventDetails.EventMemberDates.Select(x => x.Member).Count() == 1)
					{
						<p>Det här är ett enkelt event som endast gäller för en person och en dag.</p>
						@foreach (var member in Model.ViewModel.EventDetails.EventMemberDates.Select(e => e.Member).Distinct())
						{
							var isOnlyMember = Model.ViewModel.EventDetails.EventMemberDates.Select(x => x.Member).Distinct().Count() == 1;

							<div class="form-check">
								<input class="form-check-input"
									   type="checkbox"
									   id="deleteMember-@member.Id"
									   value="@member.Id"
									   name="selectedMemberIds"
								@(isOnlyMember ? "checked disabled" : "") />
								<label class="form-check-label" for="deleteMember-@member.Id">@member.Name</label>
							</div>
							<input type="hidden" name="selectedMemberIds" value="@Model.ViewModel.Member.Id" />

						}
						<p>Vill du radera detta event?</p>
					}
					<!-- Enkelt event på flera personer -->
					@if (Model.ViewModel.EventDetails.EventMemberDates.Select(x => x.Date).Distinct().Count() == 1 && Model.ViewModel.EventDetails.EventMemberDates.Select(x => x.Member).Distinct().Count() > 1)
					{
						<p>Det här eventet gäller flera personer. Välj vilka du vill ta bort eventet för:</p>
						<div id="deleteMemberListSingle">
							@foreach (var member in Model.ViewModel.EventDetails.EventMemberDates.Select(e => e.Member).Distinct())
							{
								var isSelectedMember = member.Id == Model.ViewModel.Member.Id;

								<div class="form-check">
									<input class="form-check-input member-checkbox"
										   type="checkbox"
										   id="deleteMember-@member.Id"
										   value="@member.Id"
										   name="selectedMemberIds"
										   checked="@(isSelectedMember ? "checked" : null)"
										   disabled="@(isSelectedMember ? "disabled" : null)" />
									<label class="form-check-label" for="deleteMember-@member.Id">@member.Name</label>

									@if (isSelectedMember)
									{
										<input type="hidden" name="selectedMemberIds" value="@member.Id" />
									}
								</div>
							}
						</div>
					}
					<!-- Event inom ett intervall -->
					@if (Model.ViewModel.EventDetails.EventMemberDates.Select(x => x.Date).Distinct().Count() > 1)
					{
						<p>Det här eventet är en del av ett intervall.</p>
						<div class="form-check">
							<input type="radio"
								   class="form-check-input"
								   id="deleteSingleEvent"
								   name="deleteOption"
								   value="single" checked />
							<label class="form-check-label" for="deleteSingleEvent">
								Radera endast det här eventet: <strong>@Model.ViewModel.Day.ToString("yyyy-MM-dd")</strong>
							</label>
						</div>
						<div class="form-check">
							<input type="radio"
								   class="form-check-input"
								   id="deleteAllEvents"
								   name="deleteOption"
								   value="all" />
							<label class="form-check-label" for="deleteAllEvents">Radera alla event inom intervallet</label>
						</div>
					}
					<!-- Event inom ett intervall med flera personer -->
					@if (Model.ViewModel.EventDetails.EventMemberDates.Select(x => x.Date).Distinct().Count() > 1 && Model.ViewModel.EventDetails.EventMemberDates.Select(x => x.Member).Distinct().Count() > 1)
					{
						<p>Det här eventet gäller flera personer och är en del av ett intervall. Välj vilka personer du vill ta bort för hela intervallet:</p>
						<div id="deleteMemberListInterval">
							@foreach (var member in Model.ViewModel.EventDetails.EventMemberDates.Select(e => e.Member).Distinct())
							{
								var isSelectedMember = member.Id == Model.ViewModel.Member.Id;

								<div class="form-check">
									<input class="form-check-input member-checkbox"
										   type="checkbox"
										   id="deleteMember-@member.Id"
										   value="@member.Id"
										   name="selectedMemberIds"
										   checked="@(isSelectedMember ? "checked" : null)"
										   disabled="@(isSelectedMember ? "disabled" : null)" />
									<label class="form-check-label" for="deleteMember-@member.Id">@member.Name</label>

									@if (isSelectedMember)
									{
										<input type="hidden" name="selectedMemberIds" value="@member.Id" />
									}
								</div>
							}
						</div>
					}
				</div>
				<div class="modal-footer">
					<input type="hidden" asp-for="ViewModel.EventId" value="@Model.ViewModel.EventDetails.Id" />
					<input type="hidden" asp-for="ViewModel.CalendarId" value="@Model.ViewModel.EventDetails.CalendarId" />
					<input type="hidden" asp-for="ViewModel.Day" value="@Model.ViewModel.Day" />
					<input type="hidden" asp-for="ViewModel.MemberId" value="@Model.ViewModel.Member.Id" />
					<button type="submit" class="btn btn-danger">Radera</button>
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Modal för att redigera eventet -->
<div class="modal fade" id="editEventModal" tabindex="-1" aria-labelledby="editEventModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered modal-sm">
		<div class="modal-content">

			<div class="modal-header">
				<h5 class="modal-title" id="editEventModalLabel">Redigera Event</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Stäng"></button>
			</div>

			<div class="modal-body">
				<form method="post" asp-page-handler="UpdateEvent" onsubmit="return validateEditForm()">

					<div class="mb-3">
						<label for="editEventTitle" class="form-label">Ändra titel</label>
						<input type="text" class="form-control" value="@Model.ViewModel.EventDetails.Title" asp-for=ViewModel.NewTitle id="editEventTitle" />
						<small id="editEventTitleError" class="text-danger d-none">Titel måste finnas</small>
					</div>


					@if (Model.ViewModel.EventDetails.EventMemberDates.Select(x => x.Date).Distinct().Count() > 1)
					{
						var minEventDate = Model.ViewModel.EventDetails.EventMemberDates.Min(x => x.Date) < DateTime.Today ? DateTime.Today : Model.ViewModel.EventDetails.EventMemberDates.Min(x => x.Date);
						var maxEventDate = Model.ViewModel.EventDetails.EventMemberDates.Max(x => x.Date);

						<div class="mb-3">
							<label for="editStartDate" class="form-label">Välj nytt startdatum</label>
							<input type="date" class="form-control" asp-for="ViewModel.StartDate" value="@minEventDate.ToString("yyyy-MM-dd")" id="editStartDate" />
							<small id="edit-error-start-date" class="text-danger d-none"></small>


						</div>

						<div class="mb-3">
							<label for="editEndDate" class="form-label">Välj nytt slutdatum</label>
							<input type="date" class="form-control" asp-for="ViewModel.EndDate" value="@maxEventDate.ToString("yyyy-MM-dd")" id="editEndDate" />
							<small id="edit-error-end-date" class="text-danger d-none"></small>

						</div>
						<div class="mb-3">
							<label class="form-label">Välj dagar</label>
							<div>
								<input type="checkbox" class="edit-day-checkbox" name="SelectedDays" value="Monday" @(Model.ViewModel.SelectedDays.Contains(DayOfWeek.Monday) ? "checked" : "") /> Måndag <br />
								<input type="checkbox" class="edit-day-checkbox" name="SelectedDays" value="Tuesday" @(Model.ViewModel.SelectedDays.Contains(DayOfWeek.Tuesday) ? "checked" : "") /> Tisdag <br />
								<input type="checkbox" class="edit-day-checkbox" name="SelectedDays" value="Wednesday" @(Model.ViewModel.SelectedDays.Contains(DayOfWeek.Wednesday) ? "checked" : "") /> Onsdag <br />
								<input type="checkbox" class="edit-day-checkbox" name="SelectedDays" value="Thursday" @(Model.ViewModel.SelectedDays.Contains(DayOfWeek.Thursday) ? "checked" : "") /> Torsdag <br />
								<input type="checkbox" class="edit-day-checkbox" name="SelectedDays" value="Friday" @(Model.ViewModel.SelectedDays.Contains(DayOfWeek.Friday) ? "checked" : "") /> Fredag <br />
								<input type="checkbox" class="edit-day-checkbox" name="SelectedDays" value="Saturday" @(Model.ViewModel.SelectedDays.Contains(DayOfWeek.Saturday) ? "checked" : "") /> Lördag <br />
								<input type="checkbox" class="edit-day-checkbox" name="SelectedDays" value="Sunday" @(Model.ViewModel.SelectedDays.Contains(DayOfWeek.Sunday) ? "checked" : "") /> Söndag
							</div>
						</div>
						<input type="hidden" name="editOption" value="all" />

						<small id="edit-error-right-weekdays" class="text-danger d-none"></small>
						<small id="edit-error-interval-weekdays" class="text-danger d-none"></small>
					}
					else
					{
						<div class="mb-3">
							<label for="editEventDates" class="form-label">Ändra datum för valt event</label>
							<input type="date" class="form-control" value="@Model.ViewModel.Day.ToString("yyyy-MM-dd")" asp-for="ViewModel.NewDate" id="editEventDates" />
							<small id="edit-error-selected-date" class="text-danger d-none"></small>
						</div>

						<input type="hidden" name="editOption" value="single" />

					}

					<div id="editMemberList">
						@foreach (var member in Model.ViewModel.EventDetails.EventMemberDates.Select(e => e.Member).Distinct())
						{
							<input type="hidden" name="selectedMemberIds" value="@member?.Id" />
						}
					</div>
					<small id="memberError" class="text-danger d-none">Du måste välja minst en medlem</small>
					<div class="modal-footer">
						<input type="hidden" asp-for="ViewModel.EventId" value="@Model.ViewModel.EventDetails.Id" />
						<input type="hidden" asp-for="ViewModel.Day" value="@Model.ViewModel.Day" />
						<input type="hidden" asp-for="ViewModel.MemberId" value="@Model.ViewModel.Member.Id" />
						<input type="hidden" asp-for="ViewModel.CalendarId" value="@Model.ViewModel.EventDetails.CalendarId" />

						<button type="submit" class="btn btn-primary">Spara ändringar</button>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Stäng</button>
			</div>
		</div>
	</div>
</div>